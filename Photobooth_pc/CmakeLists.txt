cmake_minimum_required (VERSION 3.15)	

enable_language(CXX)

set (CMAKE_CONFIGURATION_TYPES "Debug;Release")
set (CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} /MP")
set (CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} /Zi")

set(CMAKE_AUTOMOC ON)
set(CMAKE_AUTORCC ON)

set(PROJECT_NAME Photobooth)
project(${PROJECT_NAME} LANGUAGES CXX)

#-------------------------------------------------------------------------------------------------------------------
# GET SOURCES
#-------------------------------------------------------------------------------------------------------------------
file(GLOB_RECURSE Photobooth_src LIST_DIRECTORIES false 

		"${Photobooth_SOURCE_DIR}/Sources/*.cpp" 
		"${Photobooth_SOURCE_DIR}/Sources/*.c"
		"${Photobooth_SOURCE_DIR}/Sources/*.h"
		"${Photobooth_SOURCE_DIR}/Sources/*.qrc")

add_executable(${PROJECT_NAME} ${Photobooth_src})
set_property(DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR} PROPERTY VS_STARTUP_PROJECT ${PROJECT_NAME})

SET_TARGET_PROPERTIES(${PROJECT_NAME} PROPERTIES LINK_FLAGS    "/MANIFESTUAC:\"level='requireAdministrator' uiAccess='false'\" /SUBSYSTEM:CONSOLE")

set_property(TARGET ${PROJECT_NAME} PROPERTY MSVC_RUNTIME_LIBRARY "MultiThreaded$<$<CONFIG:Debug>:Debug>")

foreach(src IN ITEMS ${Photobooth_src})
    get_filename_component(src_path "${src}" PATH)
    file(RELATIVE_PATH rel_path "${Photobooth_SOURCE_DIR}" "${src_path}")	
    string(REPLACE "/" "\\" group_path "${rel_path}")
    source_group("${group_path}" FILES "${src}")
    target_include_directories(${PROJECT_NAME} PUBLIC "${src_path}/")
endforeach()

#-------------------------------------------------------------------------------------------------------------------
# LINK OPENCV DEPENDENCIES
#-------------------------------------------------------------------------------------------------------------------
find_package( OpenCV REQUIRED)
if (OpenCV_FOUND)
  target_link_libraries(${PROJECT_NAME} ${OpenCV_LIBS})
else ()
  message(FATAL_ERROR "opencv not found")
endif ()

#-------------------------------------------------------------------------------------------------------------------
# LINK QT DEPENDENCIES
#-------------------------------------------------------------------------------------------------------------------
find_package(Qt6 COMPONENTS Core REQUIRED)
target_link_libraries(${PROJECT_NAME} Qt6::Core)
find_package(Qt6 COMPONENTS Gui REQUIRED)
target_link_libraries(${PROJECT_NAME} Qt6::Gui)
find_package(Qt6 COMPONENTS Widgets REQUIRED)
target_link_libraries(${PROJECT_NAME} Qt6::Widgets)
find_package(Qt6 COMPONENTS Network REQUIRED)
target_link_libraries(${PROJECT_NAME} Qt6::Network)
find_package(Qt6 COMPONENTS Xml REQUIRED)
target_link_libraries(${PROJECT_NAME} Qt6::Xml)

#-------------------------------------------------------------------------------------------------------------------
# LINK TENSORFLOW
#-------------------------------------------------------------------------------------------------------------------
#set(TENSORFLOW ${Photobooth_SOURCE_DIR}/Externals/ CACHE PATH "tensorflow")
#target_include_directories(${PROJECT_NAME} PUBLIC "${TENSORFLOW}")
#target_link_libraries(${PROJECT_NAME} general "${TENSORFLOW}/tensorflow_cc.lib")

#-------------------------------------------------------------------------------------------------------------------
# PREPROCESSOR 
#-------------------------------------------------------------------------------------------------------------------
add_definitions(-DUNICODE)
add_definitions(-D_X64_MACHINE)
add_definitions(-DNOMINMAX)

#-------------------------------------------------------------------------------------------------------------------
# POST BUILD 
#-------------------------------------------------------------------------------------------------------------------
#OpenCV
get_target_property(opencvDLL opencv_world IMPORTED_LOCATION_RELEASE)
get_filename_component(opencvDLLNoExt ${opencvDLL} NAME_WE)
get_filename_component(opencvDLLDir ${opencvDLL} DIRECTORY)
add_custom_command(TARGET ${PROJECT_NAME} POST_BUILD COMMAND ${CMAKE_COMMAND} -E copy_if_different "${opencvDLLDir}/${opencvDLLNoExt}$<$<CONFIG:debug>:d>.dll" $<TARGET_FILE_DIR:${PROJECT_NAME}>)

#Tensorflow
#file(TO_NATIVE_PATH $<TARGET_FILE_DIR:${PROJECT_NAME}> PHOTOBOOTH_EXE_FOLDER)
#add_custom_command(TARGET ${PROJECT_NAME} POST_BUILD COMMAND xcopy /d /y /I "\"${TENSORFLOW}/*.dll\"" "\"${PHOTOBOOTH_EXE_FOLDER}\"")

#Qt
get_target_property(Qt6_CoreLocation Qt6::Core LOCATION)
add_custom_command(TARGET ${PROJECT_NAME} POST_BUILD COMMAND ${Qt6_CoreLocation}/../windeployqt --"$<IF:$<CONFIG:Debug>,debug,release>" $<TARGET_FILE_DIR:${PROJECT_NAME}>)
